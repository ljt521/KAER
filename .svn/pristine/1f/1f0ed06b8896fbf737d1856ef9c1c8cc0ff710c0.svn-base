<!--作者：莫岭红 功能：新建（编辑）论文发表-->
<template>
  <div v-wechat-title="title" class="newPap">
    <div class="dy-top">
      <x-header class="x-header" slot="header" @on-click-back="goToBack" :left-options="{backText: '',preventGoBack: true}">{{title}}<a slot="right"
                                                                                          @click="goEssentialInfo()">完成</a>
      </x-header>
    </div>
    <div class="backgroundStyle">
      <datetime v-model="paperPublishInfoDto.paperYear" :title="'年度'" :min-year=2000 :max-year=2099 format="YYYY"
                year-row="{value}年" placeholder="请选择"></datetime>
      <x-input title="论文名称" v-model="paperPublishInfoDto.paperName" placeholder="请填写" text-align="right" :is-type="codeValue" required></x-input>
      <div-selector :tilteValue="'期刊类型'" :dictCode="'QK'"
                    v-on:listenSelect="(value) => {paperPublishInfoDto.periodicalType = value.code}"
                    :anyData="paperPublishInfoDto.periodicalType" :is-type="codeValue" required></div-selector>
      <div-selector :tilteValue="'署名方式'" :dictCode="'SMFS'"
                    v-on:listenSelect="(value) => {paperPublishInfoDto.signType = value.code}"
                    :anyData="paperPublishInfoDto.signType" :is-type="codeValue" required></div-selector>
    </div>
  </div>
</template>
<script>
  export default {
    name: 'NewPaper',
    data () {
      return {
        codeValue: function (value) {
          return {
            valid: value !== '' || null,
          }
        },
        title: '新建论文发表',
        backField: {},
        isEdit: '',
        start:'', //状态 1为创建 0为编辑
        customerId: '',
        paperPublishInfoDto: {
          customerId: '',//所属客户
          paperYear: '',//年度
          paperName: '',//论文名称
          periodicalType: '',//期刊类型
          signType: ''//署名方式
        }
      }
    },
    mounted() {
      this.customerId = this.$route.params.id || this.$route.query.id
      if (this.$route.params.isEdit) {
        this.isEdit = this.$route.params.isEdit
        this.backField = this.$route.params.backField
        this.personId = this.$route.params.personId
        this.start = this.$route.params.start
      }
      if (this.$route.query.previousPage) {
        this.backField = {previousPage:'',subId:''}
        this.backField.previousPage = this.$route.query.previousPage
        this.backField.subId = this.$route.query.subId
        this.start = 1;
      }
    },
    created () {
      this.title = this.$route.params.title || this.$route.meta.title
      this.paperPublishInfoDto.customerId = this.$route.params.id
      if (this.$route.params.data) {
        this.paperPublishInfoDto.paperYear = this.$route.params.data.paperYear
        this.paperPublishInfoDto.paperName = this.$route.params.data.paperName
        this.paperPublishInfoDto.periodicalType = this.$route.params.data.periodicalType
        this.paperPublishInfoDto.signType = this.$route.params.data.signType
        this.paperPublishInfoDto['id'] = this.$route.params.data.id
      }
    },
    methods: {
      goEssentialInfo () {
        for(let key in this.paperPublishInfoDto) {
          switch (key) {
            case 'paperYear':
              if(this.paperPublishInfoDto[key] === '' || null) {this.$vux.toast.text('年度不能为空', 'middle'); return;}
              break
            case 'paperName':
              if(this.paperPublishInfoDto[key] === '' || null) {this.$vux.toast.text('论文名称不能为空', 'middle'); return;}
              break
            case 'periodicalType':
              if(this.paperPublishInfoDto[key] === '' || null) {this.$vux.toast.text('期刊类型不能为空', 'middle'); return;}
              break
            case 'signType':
              if(this.paperPublishInfoDto[key] === '' || null) {this.$vux.toast.text('署名方式不能为空', 'middle'); return;}
              break
          }
        }
        if (this.title === '编辑论文发表') {
          this.$put('/api/PaperPublishInfo', this.paperPublishInfoDto).then(info => {
            this.$vux.toast.text('编辑论文发表成功', 'middle')
            this.$router.push({
              path:`/userInfo/${this.paperPublishInfoDto.customerId}/follow-details/${this.paperPublishInfoDto.customerId}`,
              query:{
                previousPage: this.backField.previousPage || this.$route.query.previousPage,
                subId:this.$route.params.personId || this.backField.subId,
                isOpen:'showContent5'
              }
            })
            sessionStorage.setItem('tabIndex', '3');
          }).catch(error => {
            this.$vux.toast.text('编辑论文发表失败', 'middle')
          })
        } else if (this.title === '新建论文发表') {
          this.$post('/api/PaperPublishInfo', this.paperPublishInfoDto).then(info => {
            this.$vux.toast.text('新建论文发表成功', 'middle')
            this.$router.push({
              path:`/userInfo/${this.paperPublishInfoDto.customerId}/follow-details/${this.paperPublishInfoDto.customerId}`,
              query:{
                previousPage: this.backField.previousPage || this.$route.query.previousPage,
                subId:this.$route.query.personId,
                isOpen:'showContent5'
              }
            })
            sessionStorage.setItem('tabIndex', '3');
          }).catch(error => {
            this.$vux.toast.text('新建论文发表失败', 'middle')
          })
        }
      },
      goToBack(){
        if (this.backField.previousPage == 'concernSub' && this.backField.subId == 'undefined') {
          this.$router.push({
            path:'/subordinates-customer/' +this.$route.query.personId,
            query:{
              previousPage:this.backField.previousPage
            },
          })
          return
        }
        if (this.start == '0') {
          this.$router.push({
            path: '/see-all',
            query:{
              title:'全部论文发表信息',
              isEdit: 1,
              id:this.customerId,
              backField: this.backField,
              isOpen: 'showContent5'
            }
          })
          return
        }
        if (this.start == '1') {
          this.$router.push({
            path: '/userInfo/' + this.customerId + '/follow-details/' + this.customerId,
            query: {
              previousPage: this.backField.previousPage,
              subId: this.backField.subId,
              isOpen: 'showContent5'
            }
          })
          sessionStorage.setItem('tabIndex', '3')
          return
        }
        this.$router.push('/customer')
      },
    },
    beforeRouteLeave (to, from, next) {
      if (!to.params.id) {
        to.params.title = '全部论文发表信息'
        to.params.id = this.paperPublishInfoDto.customerId
      }
      next()
    },
  }
</script>
<style lang="less">
  .newPap {
    .dy-top {
      .x-header {
        h1.vux-header-title {
          font-size: 19px;
        }
        .vux-header-right {
          font-size: 15px;
        }
      }
    }
    .cellBox {
      height: 20px;
    }
    .backgroundStyle {
      font-size: 13px;
    }
  }


</style>

