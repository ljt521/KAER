<template>
  <div class="us-top">
    <x-header @on-click-back="goToBack" :left-options="{backText: '',preventGoBack: true}"></x-header>
    <div class="us-img">
    </div>
    <div class="us-z-top">
      <div style="position: relative;">
        <img v-if="customerDto.headImg" class="us-img-1" :src="baseUrl + customerDto.headImg" alt="">
        <!--<img v-if="!customerDto.headImg" class="us-img-1" src="../assets/image/default_head.png" alt="">-->
        <label class="img-up" for="female">img</label>
        <input ref="female" type="file" @change="loadImg" id="female" accept="image/*" class="addBorder">
      </div>
      <div class="us-care" @click="careData" v-if="isShowLeader == '0'">
        <div class="us-center" v-if="customerDto.isFocusOn == '0' ">
          <img src="../assets/image/client_details_follow.png" alt=""><span>关注</span>
        </div>
        <div class="us-center" v-if="customerDto.isFocusOn == '1'">
          <img src="../assets/image/client_details_follow_s.png" alt=""><span style="color: #FFB532"> 已关注</span>
        </div>
      </div>
      <h2 style="font-size:16px;margin: -45px 0 5px 0">{{customerDto.name}}</h2>
      <p style="margin-top:5px;text-align: center">
        <div-span v-bind:dictCode="'KSLX'" v-bind:dictItemCode="customerDto.deptCode"></div-span>
        <div-span style="font-size: 13px;" v-bind:dictCode="'ZW'" v-bind:dictItemCode="customerDto.administrative"></div-span>
        <div-span style="font-size: 13px" v-bind:dictCode="'ZC'" v-bind:dictItemCode="customerDto.title"></div-span>
      </p>
      <p v-if="customerDto.hospitalCode" style="font-size:13px;margin: 5px 0 0px 0;text-align: center; color: #888888;">
        <hos-span v-bind:code="customerDto.hospitalCode"></hos-span>
      </p>
      <div style="height: 15px;margin-bottom: 15px" class="vux-1px-b"></div>

      <grid :show-lr-borders="false" :show-vertical-dividers="false">
        <grid-item :link="{ path: '/userInfo/'+id+'/essential-info/'+id}" @on-item-click="onItemClick(1)">
          <img style="width: 22px;height: 22px;" slot="icon" src="../assets/image/client_details_basic_data.png">
          <span slot="label" class="user-span" :class="{'user-span-index':tabIndex == 1}">基本资料</span>
        </grid-item>
        <grid-item :link="{ path: '/userInfo/'+id+'/growth-archives/'+id}" @on-item-click="onItemClick(2)">
          <img style="width: 22px;height: 22px;" slot="icon" src="../assets/image/client_details_growth_archives.png">
          <span slot="label" class="user-span" :class="{'user-span-index':tabIndex == 2}">成长档案</span>
        </grid-item>
        <grid-item :link="{ path: '/userInfo/'+id+'/follow-details/'+id}" @on-item-click="onItemClick(3)">
          <img style="width: 22px;height: 22px;" slot="icon" src="../assets/image/client_details_follow_up.png">
          <span slot="label" class="user-span" :class="{'user-span-index':tabIndex == 3}">跟进详情</span>
        </grid-item>
        <grid-item :link="{ path: '/userInfo/'+id+'/dynamic-assembly/'+id}" @on-item-click="onItemClick(4)">
          <img style="width: 22px;height: 22px;" slot="icon" src="../assets/image/client_details_dynamic.png">
          <span slot="label" class="user-span" :class="{'user-span-index':tabIndex == 4}">动态</span>
        </grid-item>
      </grid>
    </div>

    <div class="us-bottom-common">
      <router-view></router-view>
    </div>
    <!--剪切-->
    <div v-if="showBox">
      <div class="wrapper">
        <vueCropper
          ref="cropper"
          :img="option.img"
          :outputSize="option.size"
          :outputType="option.outputType"
          :info="false"
          :full="option.full"
          :canMove="option.canMove"
          :canMoveBox="option.canMoveBox"
          :fixedBox="option.fixedBox"
          :original="option.original"
          :autoCrop="option.autoCrop"
          :fixed="option.fixed"
          :fixedNumber="option.fixedNumber"
        ></vueCropper>
        <div class="btn">
          <a @click="cancel()">取消</a>
          <a @click="finish('img')">确定</a>
        </div>
      </div>
    </div>
  </div>

</template>

<script>
  import {Grid, GridItem} from 'vux'
  import {VueCropper} from 'vue-cropper'

  export default {
    name: 'UserInfo',
    components: {
      Grid,
      GridItem,
      VueCropper
    },
    data () {
      return {
        care: true,
        myConcernsCustomerDto: {
          customerId: this.$route.params.id,
          isFocusOn: 1
        },
        id: this.$route.params.id,
        customerDto: {},
        imgSrc: '',
        tabIndex: JSON.parse(sessionStorage.getItem('tabIndex')) || 1,
        url: '',
        baseUrl: this.$baseURL,
        option: {
          img: '',//裁切图片的地址
          outputSize: 0.1,//裁剪生成图片的质量 0.1-1
          full: false,//是否输出原图比例的截图
          outputType: 'jpg',//裁剪生成图片的格式
          canMove: true,//图片是否允许滚轮缩放
          fixedBox: true,//固定截图框大小 不允许改变
          original: false,//上传图片按照原始比例渲染
          canMoveBox: false,//截图框能否拖动
          autoCropWidth: 200,
          autoCropHeight: 200,
          autoCrop:true,//是否默认生成截图框
          // 开启宽度和高度比例
          fixed: true,
          fixedNumber: [1, 1]
        },
        showBox: false,
        isShowIsEdit: '',
        isShowLeader:'',
        backField:this.$route.query
      }
    },
    created () {
      this.getCustomer(this.id)
    },
    methods: {
      /*关注*/
      careData () {
        this.customerDto.isFocusOn = !this.customerDto.isFocusOn;
        if (this.customerDto.isFocusOn) {/*关注*/
          this.$post('/api/myconcernscustomer', this.myConcernsCustomerDto).then(info => {
            this.$vux.toast.text('关注成功', 'middle')
          }).catch(error => {
            this.$vux.toast.text('取消关注', 'middle')
          })
          this.myConcernsCustomerDto.isFocusOn = 1;
        } else {/*取消关注*/
          this.$post('/api/myconcernscustomer/delMyConcernsCustomer', this.myConcernsCustomerDto).then(info => {
            this.$vux.toast.text('取消关注成功', 'middle')
          }).catch(error => {
            this.$vux.toast.text('取消关注成功', 'middle')
          })
          this.myConcernsCustomerDto.isFocusOn = 0;
        }

      },
      /*返回*/
      goToBack () {
        //从所属客户页面跳转，并返回到所属客户列表
        if (this.backField.previousPage==='dynamic' || this.backField.previousPage==='AllSubordinates' || this.backField.previousPage === 'customer' || this.backField.previousPage === 'concernSub' ){
          this.$router.push({
            path: '/subordinates-customer/' + this.backField.subId,
            query:{previousPage:this.$route.query.previousPage}
          })
          return
        }else if (this.backField.previousPage === 'dynamicPersonName') {
          this.$router.push({
            path: '/dynamic'
          })
          return
        }

        this.$router.push('/customer')
      },
      /*客户信息*/
      getCustomer (id) {
        this.$get('/api/customer/' + id).then(info => {
          this.customerDto = info
          this.imgSrc = this.customerDto.headImg
          this.isShowIsEdit = info.isEdit
          this.isShowLeader = info.isLeader
        })
      },
      loadImg (e) {
        if(this.isShowIsEdit == 0) {
          return
        }
        //获取文件
        const file = this.$refs.female.files
        let size = Math.floor(file[0].size)

        let format = 'png,jpg,jpeg';
        let fileSufName = file[0].name.substring(file[0].name.lastIndexOf('.') + 1);
        if (format.indexOf(fileSufName) == -1) {
          this.$vux.toast.text('格式错误','middle')
          return
        }
        //判断文件长度不能为0
        if (file.length == 0) {
          this.$vux.toast.text('请选择图片','middle')
           return
        } else {
          const reader = new FileReader()
          reader.readAsDataURL(e.target.files[0]) // 读出 base64
          /*读取过程中，没有出现异常时*/
          reader.onloadend = () => {
            const dataURL = reader.result//base64
            this.option.img = dataURL
            e.target.value = ''
            this.showBox = true
          }
        }
      },
      upImg(e) {
        const imageData = new FormData()
        imageData.append('file', e)
        this.$post('/api/file/change-head', imageData, 'header').then(info => {
          this.customerDto.headImg = info.url
          // info.url 返回的路径
          this.imgSrc = info.url
          this.$post('/api/customer/uploadHeadImg', this.customerDto).then(info => {
            this.showBox = false
            this.$vux.toast.text('上传成功','middle')
          }).catch(error => {
            this.showBox = false
            this.$vux.toast.text('上传失败','middle')
          })
        })
      },
      finish (type) {
        if (type === 'blob') {
          this.$refs.cropper.getCropBlob((data) => {
            this.upImg(data)
          })
        } else {
          this.$refs.cropper.getCropData((data) => {
            const bili = 1.5
            this.suofang(data, bili)
          })
        }
      },
      cancel() {
        this.showBox = false
      },
      onItemClick (value) {
        this.tabIndex = value;
      },
      suofang(base64, bili){
        const _this = this
        //处理缩放，转格式
        let _img = new Image();
        _img.src = base64;
        _img.onload = function() {
          let _canvas = document.createElement("canvas");
          const w = this.width / bili;
          const h = this.height / bili;
          _canvas.setAttribute("width", w);
          _canvas.setAttribute("height", h);
          _canvas.getContext("2d").drawImage(this, 0, 0, w, h);
          const base64 = _canvas.toDataURL("image/jpeg");
          _canvas.toBlob(function(blob) {
            if(blob.size > 1024 * 50){
              _this.suofang(base64, bili);
            }else{
              _this.upImg(blob)
            }
          }, "image/jpeg");
        }
      }
    }
  }
</script>

<style lang="less">
  .us-top {
    .vux-header, .us-img {
      background-color: #074089;
    }
    .us-img {
      position: relative;
      height: 140px;
      top: -1px;
    }
    .us-z-top {
      margin: 0 15px -100px;
      position: relative;
      top: -120px;
      background-color: #fff;
      border-radius: 5px;
      .vux-1px-b {
        &:after {
          border-bottom: 1px solid #DDDDDD;
          left: 18px;
          right: 18px;
        }
      }
      .us-img-1 {
        position: relative;
        top: -45px;
        width: 75px;
        height: 75px;
        border-radius: 50%;
        background-color: aliceblue;
      }
      .addBorder {
        opacity: 0;
        /*filter: alpha(opacity=0);*/
        height: 100px;
        width: 100px;
        z-index: -9999;
        position: absolute;
        left: 50%;
        transform: translate(-50%, 0);
        opacity: 0;
      }
      .img-up {
        display: inline-block;
        position: absolute;
        width: 60px;
        height: 60px;
        background-color: pink;
        top: -40px;
        transform: translate(-110%, 0);
        opacity: 0;
      }
      .us-care {
        width: 67px;
        height: 30px;
        position: absolute;
        top: 11px;
        right: -3px;
        border-top-left-radius: 15px;
        border-bottom-left-radius: 15px;
        background: #F2F3F5;
        text-align: center;
        font-size: 13px;
        color: #A4A4A4;
        .us-center {
          margin-top: 4px;
          img {
            vertical-align: top;
            height: 15px;
            margin-left: 5px;
          }
        }

      }
      .weui-grid {
        padding: 0;
      }
      .weui-grids::before {
        border: none;
      }
      .weui-grid::after {
        content: none;
      }
      .weui-grid {
        text-decoration: none;
      }
      .weui-grid__label {
        padding-bottom: 10px;
      }
    }
    .us-bottom-common {
      position: relative;
      top: -10px;
      .scrollable .vux-tab-item {
        flex: 0 0 20%;
      }
    }
    .user-span {
      color: #888888;
      font-size: 13px;
    }
    .user-span-index {
      color: #074089;
      font-size: 13px;
    }
    .box{
      position: relative;
      height: 100%;
    }
    .wrapper{
      position: fixed;
      width: 100%;
      top: 0;
      height: calc(100% - 50px);
    }
    .vue-cropper{
      background: black;
      background-image: none!important;
    }
    .btn{
      height: 50px;
      /* width: 100%; */
      padding: 0 15px;
      background-color: #000;
    }
    .btn a{
      color: white;
      font-size: 14px;
      line-height: 50px;
      display: inline-block;
    }
    .btn a:nth-of-type(1){
      float: left;
    }
    .btn a:nth-of-type(2){
      float: right;
    }
  }
</style>
