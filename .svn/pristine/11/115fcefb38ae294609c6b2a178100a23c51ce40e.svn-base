<template>
  <div class="cu-app">
    <!--搜索-->
    <div style="position: fixed;width: 100%;top: 0;z-index: 99;height: 80px">
      <search-box v-model="conText" @on-search="searClick" @on-enter="enterBtn" @on-change="searchChange"></search-box>
      <div style="position: fixed;top:40px;background-color: #fff;width: 100%;">
        <div class="cu-type2">
          <div-selector v-bind:dictCode="'KSLX'" v-bind:tilteValue="'科室类型'"
                        v-on:listenSelect="departmentChange"></div-selector>
        </div>
        <div class="cu-type1">
          <div-selector v-bind:dictCode="'QY'" v-bind:tilteValue="'区域'" v-on:listenSelect="areaChange"></div-selector>
        </div>
      </div>
    </div>
    <div class="" style="height: 75px"></div>

    <div style="overflow: hidden">
      <scroller :height="'-120'" lock-x @on-scroll-bottom="onScrollBottom" ref="scrollerBottom"
                :scroll-bottom-offst="20">
        <div>
          <!--我的-->
          <div class="cu-con">
            <flexbox>
              <flexbox-item>
                <div class="flex-demo"><p class="cu-span"><span class="cu-left"></span><span class="cu-right">我的</span>
                </p></div>
              </flexbox-item>
              <!-- <flexbox-item><div class="flex-demo"><div class="cu-div"><i style="position: relative;top: -3px;"><x-icon type="ios-plus-empty" size="25"></x-icon></i><span @click="goNewCustomer">新建客户</span></div></div></flexbox-item> -->
            </flexbox>
            <div class="cu-content" v-for="(customer,index) in customerData" :key="index">
              <div class="cu-content-top">
                <div class="user-img" @click="goCustomerInfo(customer.id)">
                  <img v-bind:src="baseUrl + customer.headImg" alt="">
                </div>
                <div class="userImg-r" @click="goCustomerInfo(customer.id)">
                  <p><span style="font-size: 15px;padding-right: 10px;">{{customer.name}}</span>
                    <span style="font-size: 18px;padding-right: 10px;">
                      <div-span style="font-size: 13px" v-bind:dictCode="'ZC'"
                                v-bind:dictItemCode="customer.title"></div-span>
                    </span>
                    <span class="cu-title" v-if="customer.isFollowUp == '1'">待跟进</span></p>
                  <p>
                    <img class="cu-img-size" src="../assets/image/client_hospital.png" alt="">
                    <span style="color: #888888;font-size: 13px" class="cu-span-top">
                      {{customer.hospitalName}}
                      </span>
                  </p>
                  <p style="margin-top: 3px">
                    <img class="cu-img-size" src="../assets/image/client_department.png" alt="">
                    <span style="color: #888888;font-size: 13px" class="cu-span-top">
                        <div-span v-bind:dictCode="'KSLX'" v-bind:dictItemCode="customer.deptCode"></div-span>
                      </span>
                  </p>
                </div>
                <div class="cu-bottom">
                  <div class="cu-bottom-l" @click="goToDynamic(customer.id)">
                    <img style="width: 16px;height: 16px;" src="../assets/image/client_dynamic.png" alt=""/>
                    <span class="cu-span-top">动态</span>
                  </div>
                  <div @click="openDiaLog(customer.id)" class="cu-bottom-r">
                    <img style="width: 16px;height: 16px;" src="../assets/image/client_daily_follow_up.png" alt=""/>
                    <span class="cu-span-top">日常跟进</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!--下属的-->
          <div class="cu-con" v-if="hasPermission == '0'">
            <flexbox>
              <flexbox-item>
                <div class="flex-demo"><p class="cu-span"><span class="cu-left"></span><span class="cu-right">下属的</span>
                </p></div>
              </flexbox-item>
              <flexbox-item>
                <div class="flex-demo">
                  <div class="cu-div" v-on:click="goAllSubordinates"><span><x-icon type="ios-arrow-forward"
                                                                                   size="20"></x-icon></span>
                    <span class="x-icon-span">全部下属</span>
                  </div>
                </div>
              </flexbox-item>
            </flexbox>
            <div class="cu-content" v-for="(subCustomer,index) in subCustomerData" :key="index">
              <div class="cu-content-top">
                <div class="user-img" @click="goCustomerInfo(subCustomer.id)">
                  <img v-bind:src="baseUrl + subCustomer.headImg" alt="">
                  <span style="display: inline-block;position: absolute;top:66px;left: 16px;color:#eaa304;"
                        v-if="subCustomer.isFocusOn == '1'">已关注</span>
                </div>

                <div class="userImg-r" @click="goCustomerInfo(subCustomer.id)">
                  <p><span style="font-size: 15px;padding-right: 5px;">{{subCustomer.name}}</span>
                    <div-span style="font-size: 13px;" v-bind:dictCode="'ZC'"
                              v-bind:dictItemCode="subCustomer.title"></div-span>
                    <span class="cu-title" v-if="subCustomer.isFollowUp == '1'">待跟进</span>
                  </p>
                  <p style="margin-top: 3px"><img class="cu-img-size" style="position: relative;"
                                                  src="../assets/image/client_hospital.png" alt="">
                    <span style="color: #888888;font-size: 13px" class="cu-span-top">
                      {{subCustomer.hospitalName}}
                    </span></p>
                  <p style="margin-top: 3px">
                    <img class="cu-img-size" style="position: relative;" src="../assets/image/client_department.png"
                         alt=""/>
                    <span style="color: #888888;font-size: 13px;display: inline-block"
                          class="cu-span-top">
                      <div-span style="position: relative;display: inline-block;line-height: 19px;"
                                v-bind:dictCode="'KSLX'" v-bind:dictItemCode="subCustomer.deptCode"></div-span>
                    </span>

                  </p>
                </div>
                <div style="display: inline-block; position: absolute;top:58px;right: 3px"
                     @click="goCustomerByLeaderId(subCustomer.leaderId)">
              <span style="color: #888888;max-width: calc(100% - 160px);line-height:21px;"
                    class="span-web">
                 <img style="height: 13px;padding-right: 3px" src="../assets/image/client_responsible_person.png"
                      alt=""/>{{subCustomer.leaderName}}
              </span>
                </div>
                <div class="cu-bottom">
                  <div class="cu-bottom-l" @click="goToDynamic(subCustomer.id)">
                    <img style="width: 16px;height: 16px;" src="../assets/image/client_dynamic.png" alt=""/>

                    <span class="cu-span-top">动态</span>
                  </div>
                  <div @click="openDiaLog(subCustomer.id)" class="cu-bottom-r">
                    <img style="width: 16px;height: 16px;" src="../assets/image/client_daily_follow_up.png" alt=""/>
                    <span class="cu-span-top">日常跟进</span>
                  </div>
                </div>
              </div>
            </div>
            <div style="padding: 10px" @click="onScrollBottom()" v-if="sizeData < sumData">查看更多...
              <load-more v-if="onFetching" tip="loading"></load-more>
            </div>
            <div style="padding: 10px" @click="onScrollBottom()" v-if="sizeData > sumData">已到底</div>
          </div>
          <!--可查看的-->
          <div class="cu-con" v-if="hasPermission == '1'">
            <flexbox>
              <flexbox-item>
                <div class="flex-demo"><p class="cu-span"><span class="cu-left"></span><span
                  class="cu-right">可查看的</span>
                </p></div>
              </flexbox-item>
              <flexbox-item>
                <div class="flex-demo">
                  <div class="cu-div" v-on:click="goAllColleagues"><span><x-icon type="ios-arrow-forward"
                                                                                 size="20"></x-icon></span>
                    <span class="x-icon-span">同事</span>
                  </div>
                </div>
              </flexbox-item>
            </flexbox>
            <div class="cu-content" v-for="(pisCustomer,index) in pisCustomerData" :key="index">
              <div class="cu-content-top" style="padding-bottom:10px;">
                <div class="user-img" @click="goCustomerInfo(pisCustomer.id)">
                  <img v-bind:src="baseUrl + pisCustomer.headImg" alt="">
                  <span style="display: inline-block;position: absolute;top:66px;left: 16px;color:#eaa304;"
                        v-if="pisCustomer.isFocusOn == '1'">已关注</span>
                </div>

                <div class="userImg-r" @click="goCustomerInfo(pisCustomer.id)">
                  <p><span style="font-size: 15px;padding-right: 5px;">{{pisCustomer.name}}</span>
                    <div-span style="font-size: 13px;" v-bind:dictCode="'ZC'"
                              v-bind:dictItemCode="pisCustomer.title"></div-span>
                    <span class="cu-title" v-if="pisCustomer.isFollowUp == '1'">待跟进</span>
                  </p>
                  <p style="margin-top: 3px"><img class="cu-img-size" style="position: relative;"
                                                  src="../assets/image/client_hospital.png" alt="">
                    <span style="color: #888888;font-size: 13px" class="cu-span-top">
                    {{pisCustomer.hospitalName}}
                </span>
                  </p>

                  <p style="margin-top: 3px">
                    <img class="cu-img-size" style="position: relative;" src="../assets/image/client_department.png"
                         alt=""/>
                    <span style="color: #888888;font-size: 13px;display: inline-block;line-height: 19px;"
                          class="cu-span-top">
                      <div-span style="position: relative;display: inline-block;line-height: 19px;"
                                v-bind:dictCode="'KSLX'" v-bind:dictItemCode="pisCustomer.deptCode"></div-span>
                    </span>

                  </p>

                </div>
                <div style="display: inline-block; position: absolute;top:58px;right: 3px"
                     @click="goCustomerByLeaderId(pisCustomer.leaderId)">
                <span style="color: #888888;max-width: calc(100% - 160px);line-height:21px;"
                      class="span-web">
                 <img style="height: 13px;padding-right: 3px" src="../assets/image/client_responsible_person.png"
                      alt=""/>{{pisCustomer.leaderName}}
              </span>
                </div>
              </div>
            </div>
            <div style="padding: 10px" @click="onScrollBottom()" v-if="sizeData < sumData">查看更多...
              <load-more style="padding: 15px" v-if="onFetching" tip="loading"></load-more>
            </div>
            <div style="padding: 5px" @click="onScrollBottom()" v-if="sizeData > sumData">已到底</div>
          </div>
        </div>
      </scroller>
      <new-dia-log ref="NewDiaLogDom"></new-dia-log>
    </div>
  </div>
</template>

<script>
  import {Scroller, LoadMore} from 'vux'

  export default {
    name: 'Customer',
    components: {
      Scroller,
      LoadMore,
    },
    watch: {
      '$route': function (newVal, oldVal) {
        if (newVal.path == '/customer' && sessionStorage.getItem('path')) {
          newVal.meta.keepAlive = true
        } else if (newVal.path == '/customer' && !sessionStorage.getItem('path')) {
          newVal.meta.keepAlive = false
          sessionStorage.setItem('path', newVal.path);
        }
      }
    },
    data () {
      return {
        baseUrl: this.$baseURL,
        area: '',
        deptCode: '',
        customerData: [],
        subCustomerData: [],
        onFetching: false,
        pisCustomerData: [],
        hasPermission: 0,
        sumData: 0,
        sizeData: 5,
        orderHight: '',
        conText: '',
        searchData: '',
        allFlag: false,
      }
    },
    mounted () {
      //我的客户列表
      this.$get('/api/customer/getCustomerByLeader', {sort: 'isFollowUp,name,DESC'}).then(info => {
        this.customerData = info
      }).catch(error => {
        console.log(error)
      })
      //初次渲染页面时---------------
      //查询该用户是否存在权限列表中
      this.$get('/api/customerPermisson/hasPermisson').then(info => {
        this.hasPermission = info.hasPermission
        if (this.hasPermission == 0) {
          //下属的客户列表
          this.$search('/api/customer/getCustomerBySubPerson', {
            sort: 'isFocusOn,isFollowUp,name,DESC',
            page: 0,
            size: this.sizeData
          }).then(info => {
            this.subCustomerData = info
            this.sumData = this.$headers['x-total-count']
            this.onFetching = info.length == 0
          }).catch(error => {
            console.log(error)
          })
        } else {
          //可查看的客户列表
          this.$search('/api/customer/getCustomerByPermission', {
            sort: 'name,DESC',
            page: 0,
            size: this.sizeData
          }).then(info => {
            this.pisCustomerData = info
            this.sumData = this.$headers['x-total-count'];
            this.onFetching = info.length == 0
          }).catch(error => {
            console.log(error)
          })
        }
      }).catch(error => {
        console.log(error)
      })
    },
    methods: {
      goAllColleagues () {
        this.$router.push('/all-colleagues')
      },
      goAllSubordinates () {
        this.$router.push('/all-subordinates')
      },
      openDiaLog (id) {
        let self = this
        let start = 2
        self.$refs['NewDiaLogDom'].isShowDia(true, id, start)
      },
      goToDynamic (id) {
        this.$router.push({
          path: '/userInfo/' + id + '/dynamic-assembly/' + id
        })
        sessionStorage.setItem('tabIndex', '4')
      },
      goCustomerInfo (id) {
        this.$router.push({
          path: '/userInfo/' + id + '/essential-info/' + id,
        })
      },
      goCustomerByLeaderId (id) {
        this.$router.push({
          path: '/subordinates-customer/' + id,
          query: {previousPage: 'customer'}
        })
      },
      areaChange (e) {
        this.sizeData = 5;
        this.area = e.code
        let obj = {
          area: this.area || undefined,
          deptCode: this.deptCode || undefined,
          name: this.searchData || undefined,
        }
        obj = JSON.parse(JSON.stringify(obj))
        //查询我的客户
        this.$search('/api/customer/getCustomerByLeader', {
          sort: 'isFollowUp,name,DESC',
        }, obj).then(info => {
          this.customerData = info
        }).catch(error => {
          console.log(error)
        })

        //查询权限列表
        if (this.hasPermission == 0) {
          //下属的客户列表
          this.$search('/api/customer/getCustomerBySubPerson', {
            sort: 'isFocusOn,isFollowUp,name,DESC',
            page: 0,
            size: 10
          }, obj).then(info => {
            this.subCustomerData = info
            this.onFetching = info.length == 0
            this.allFlag = false
            this.sumData = this.$headers['x-total-count']
          }).catch(error => {
            console.log(error)
          })
        } else {
          //可查看的客户列表
          this.$search('/api/customer/getCustomerByPermission', {
            sort: 'name,DESC',
            page: 0,
            size: 10
          }, obj).then(info => {
            this.pisCustomerData = info
            this.onFetching = info.length == 0
            this.allFlag = false
            this.sumData = this.$headers['x-total-count']
          }).catch(error => {
            console.log(error)
          })
        }
        this.$nextTick(() => {
          if (this.$refs.scrollerBottom) {
            this.$refs.scrollerBottom.reset({top: 0})
          }
        })
      },
      departmentChange (e) {
        this.sizeData = 5;
        this.deptCode = e.code
        let obj = {
          area: this.area || undefined,
          deptCode: this.deptCode || undefined,
          name: this.searchData || undefined,
        }
        obj = JSON.parse(JSON.stringify(obj))
        //我的客户列表
        this.$search('/api/customer/getCustomerByLeader', {
          sort: 'isFollowUp,name,DESC',
        }, obj).then(info => {
          this.customerData = info
        }).catch(error => {
          console.log(error)
        })
        if (this.hasPermission == 0) {
          //我的客户列表
          this.$search('/api/customer/getCustomerBySubPerson', {
            sort: 'isFocusOn,isFollowUp,name,DESC',
            page: 0,
            size: 5
          }, obj).then(info => {
            this.subCustomerData = info
            this.onFetching = info.length == 0
            this.allFlag = false
            this.sumData = this.$headers['x-total-count']
          }).catch(error => {
            console.log(error)
          })
        } else {
          //可查看的客户列表
          this.$search('/api/customer/getCustomerByPermission', {
            sort: 'name,DESC',
            page: 0,
            size: 10
          }, obj).then(info => {
            this.pisCustomerData = info
            this.onFetching = info.length == 0
            this.allFlag = false
            this.sumData = this.$headers['x-total-count']
          }).catch(error => {
            console.log(error)
          })
        };
        this.$nextTick(() => {
          if (this.$refs.scrollerBottom) {
            this.$refs.scrollerBottom.reset({top: 0})
          }
        })
      },
      keywordSearch (e) {
        this.searchData = e
        let obj = {
          area: this.area || undefined,
          deptCode: this.deptCode || undefined,
          name: this.searchData || undefined,
        }
        obj = JSON.parse(JSON.stringify(obj))
        this.$search('/api/customer/getCustomerByLeader', {
          sort: 'isFollowUp,name,DESC',
        }, obj).then(info => {
          this.customerData = info
        }).catch(error => {
          console.log(error)
        })
        if (this.hasPermission == 0) {
          //下属的客户列表
          this.$search('/api/customer/getCustomerBySubPerson', {
            sort: 'isFocusOn,isFollowUp,name,DESC',
            page: 0,
            size: 5
          }, obj).then(info => {
            this.subCustomerData = info
            this.sumData = this.$headers['x-total-count']
            this.allFlag = sizeData < this.$headers['x-total-count']
          }).catch(error => {
            console.log(error)
          })
        } else {
          //可查看的客户列表
          this.$search('/api/customer/getCustomerByPermission', {
            sort: 'name,DESC',
            page: 0,
            size: 10
          }, obj).then(info => {
            this.pisCustomerData = info
            this.sumData = this.$headers['x-total-count']
            this.allFlag = sizeData < this.$headers['x-total-count']
          }).catch(error => {
            console.log(error)
          })
        }
        this.$nextTick(() => {
          if (this.$refs.scrollerBottom) {
            this.$refs.scrollerBottom.reset({top: 0})
          }
        })
      },
      getMorData () {
        this.sizeData = 5;
        this.sizeData = this.sizeData + 10
        let obj = {
          area: this.area || undefined,
          deptCode: this.deptCode || undefined,
          name: this.searchData || undefined,
        }
        obj = JSON.parse(JSON.stringify(obj))
        if (this.hasPermission == 0) {
          //下属的客户列表
          this.$search('/api/customer/getCustomerBySubPerson', {
            sort: 'isFocusOn,isFollowUp,name,DESC',
            page: 0,
            size: this.sizeData,
          }, obj).then(info => {
            this.subCustomerData = info
            this.sumData = this.$headers['x-total-count']
            if (this.sumData == 0) {
              this.$vux.toast.text('已到底线', 'middle')
              return
            }
            if (this.sizeData > this.sumData) {
              this.$vux.toast.text('已获取全部', 'middle')
            }
          }).catch(error => {
            console.log(error)
          })
        } else {
          //可查看的客户列表
          this.$search('/api/customer/getCustomerByPermission', {
            sort: 'name,DESC',
            page: 0,
            size: this.sizeData
          }, obj).then(info => {
            this.pisCustomerData = info
            this.sumData = this.$headers['x-total-count']
            if (this.sumData == 0) {
              this.$vux.toast.text('已到底线', 'middle')
              return
            }
            if (this.sizeData > this.sumData) {
              this.$vux.toast.text('已获取全部', 'middle')
            }
          }).catch(error => {
            console.log(error)
          })
        }
      },
      onScrollBottom () {
        let _this = this
        if (_this.allFlag) {
          _this.onFetching = false
          return
        }

        if (this.onFetching) {
          // this.$vux.toast.text('', 'middle')
        } else {
          this.onFetching = true
          setTimeout(() => {
            _this.sizeData = _this.sizeData + 10
            this.$nextTick(() => {
              this.$refs.scrollerBottom.reset()
            })
            if (_this.hasPermission == 0) {
              _this.$search('/api/customer/getCustomerBySubPerson', {
                sort: 'isFocusOn,isFollowUp,name,DESC',
                page: 0,
                size: _this.sizeData
              }, {
                area: _this.area,
                deptCode: _this.deptCode
              }).then(info => {
                _this.subCustomerData = info
                _this.sumData = this.$headers['x-total-count']
                if (_this.sizeData > _this.sumData) {
                  _this.$vux.toast.text('已获取全部', 'middle')
                  _this.allFlag = true
                  return
                }
                if (this.sumData == 0) {
                  _this.$vux.toast.text('无数据', 'middle')
                  return
                }
                _this.onFetching = false
              }).catch(error => {
                console.log(error)
              })
            } else {
              //按权限查询客户列表
              _this.$search('/api/customer/getCustomerByPermission', {
                sort: 'name,DESC',
                page: 0,
                size: _this.sizeData
              }, {
                area: _this.area,
                deptCode: _this.deptCode
              }).then(info => {
                _this.pisCustomerData = info
                _this.sumData = _this.$headers['x-total-count']
                if (_this.sizeData > _this.sumData) {
                  _this.$vux.toast.text('已获取全部', 'middle')
                  _this.allFlag = true
                  return
                }
                if (_this.sumData == 0) {
                  _this.$vux.toast.text('无数据', 'middle')
                  return
                }
                _this.onFetching = false
              }).catch(error => {
                console.log(error)
              })
            }
          }, 2000)
        }
      },
      searClick (e) {
        this.keywordSearch(e)
      },
      enterBtn (e) {
        this.keywordSearch(e)
      },
      searchChange (e) {
        if (e == null || e == '') {
          this.keywordSearch(e)
        }
      }
    },
  }
</script>
<style lang="less">
  .cu-app {
    .weui-search-bar__form {
      border-radius: 50%;
    }
    .weui-search-bar {
      padding: 4px 10px;
    }
    .weui-search-bar__input {
      padding: 5px 2px !important;
    }
    .weui-search-bar {
      background-color: #073f89;
    }
    .weui-search-bar__label {
      top: 5px;
    }

    .cu-type1, .cu-type2 {
      display: inline-block;
      background-color: #fff;
      float: left;
      width: 50%;
      .vux-selector.weui-cell_select-after {
        background-color: #fff;
        height: 35px;
      }
      .weui-label {
        width: 60px !important
      }
    }
    .cu-span {
      margin: 0;
      .cu-left {
        float: left;
        width: 2px;
        background-color: #073f89;
        height: 15px;
        border-radius: 3px;
      }
      .cu-right {
        padding-left: 5px;
        position: relative;
        top: -1px;
      }
    }
    .cu-div {
      text-align: right;
      color: #19498b;
      .x-icon-span {
        position: relative;
        top: 1px;
      }
      span {
        float: right;
      }
      svg {
        fill: #19498b;
      }
    }
    .cu-con {
      padding: 0 15px;
      margin: 18px 0;
      .cu-content {
        background-color: #fff;
        margin-top: 10px;
        border-radius: 5px;
        box-shadow: 0 0 2px 2px #eee;
        .cu-content-top {
          position: relative;
          padding-top: 10px;
          .user-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e6e7ec;
            overflow: hidden;
            display: inline-block;
            float: left;
            margin: 4px 0 0 10px;
            img {
              width: 50px;
              height: 50px;
            }
          }
          .userImg-r {
            width: calc(100% - 75px);
            margin-left: 70px;
            position: relative;
            .cu-title {
              font-size: 11px;
              width: 42px;
              background-color: #f6be07;
              display: inline-block;
              border-radius: 5px;
              color: #ffffff;
              text-align: center;
              line-height: 18px;
              position: relative;
              top: -1px;
            }
          }
          .cu-bottom {
            height: 32px;
            width: 100%;
            background-color: #F7F8F9;
            border-radius: 0 0 5px 5px;
            margin-top: 8px;
            .cu-bottom-l, .cu-bottom-r {
              float: left;
              width: calc(50% - 1px);
              line-height: 20px;
              font-weight: 600;
              font-size: 13px;
              position: relative;
              top: 5px;
              img {
                position: relative;
                top: 5px;
                right: 3px;
              }
            }
            .cu-bottom-r {
              border-left: 1px solid #ccc;
            }
          }
        }

      }
    }
  }

  p {
    margin: 0;
    text-align: left;
  }

  .cu-img-size {
    float: left;
    padding-right: 5px;
    width: 15px;
    height: 15px;
    margin-top: 4px
  }

  .cu-span-top {
    position: relative;
    top: 2px
  }

  .cu-gz {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    position: absolute;
    background-color: #fff;
    border: 0;
    top: 30px;
    right: 5px;
    overflow: hidden;
  }

  .span-web {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .weui-search-bar__input {
    padding: 2px 2px !important;
  }
</style>
