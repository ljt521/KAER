<!--作者：莫岭红 功能：新建(编辑)参与课题-->
<template>
  <div v-wechat-title="title" class="newTop">
    <div class="dy-top">
      <x-header class="x-header" slot="header" @on-click-back="goToBack" :left-options="{backText: '',preventGoBack: true}">{{title}}<a slot="right"
                                                                                          @click="goEssentialInfo()">完成</a>
      </x-header>
    </div>
    <div class="backgroundStyle">
      <datetime
        format="YYYY"
        v-model="partakeResearchDto.beginDate"
        title="开始年度"
        placeholder="请选择"></datetime>
      <x-input title="课题名称" v-model="partakeResearchDto.researchName" placeholder="请填写" text-align="right"  :is-type="codeValue" required></x-input>
      <div-selector :tilteValue="'课题类型'" :dictCode="'KTLX'"
                    v-on:listenSelect="(value) => {partakeResearchDto.researchType = value.code}"
                    :anyData="partakeResearchDto.researchType"  :is-type="codeValue" required></div-selector>
      <div v-if="partakeResearchDto.researchType == 'KTLX04'">
        <x-input type="text" placeholder="请填写" v-model="partakeResearchDto.researchTypeOther" :is-type="codeValue"
                 text-align="right" required></x-input>
      </div>
      <div-selector :tilteValue="'参与方式'" :dictCode="'CYFS'"
                    v-on:listenSelect="(value) => {partakeResearchDto.partakeMode = value.code}"
                    :anyData="partakeResearchDto.partakeMode"  :is-type="codeValue" required></div-selector>
      <div v-if="partakeResearchDto.partakeMode == 'CYFS04'">
        <x-input type="text" placeholder="请填写" v-model="partakeResearchDto.partakeModeOther" :is-type="codeValue"
                 text-align="right" required></x-input>
      </div>
    </div>
  </div>
</template>
<script>
  export default {
    name: 'NewTopic',
    data () {
      return {
        codeValue: function (value) {
          return {
            valid: value !== '' || null,
          }
        },
        title: '新建参与课题',
        backField: {},
        isEdit: '',
        start:'', //状态 1为创建 0为编辑
        customerId: '',
        partakeResearchDto: {
          customerId: '',//所属客户
          beginDate: '',//开始年度
          researchName: '',//课题名称
          researchType: '',//课题类型
          researchTypeOther: '',//课题类型其他
          partakeMode: '',//参与方式
          partakeModeOther: ''
        }

      }
    },
    mounted() {
      this.customerId = this.$route.params.id || this.$route.query.id

      if (this.$route.params.isEdit) {
        this.isEdit = this.$route.params.isEdit
        this.backField = this.$route.params.backField
        this.start = this.$route.params.start
      }
      if (this.$route.query.previousPage) {
        this.backField = {previousPage:'',subId:''}
        this.backField.previousPage = this.$route.query.previousPage
        this.backField.subId = this.$route.query.subId
        this.start = 1;
      }
    },
    created () {
      this.title = this.$route.params.title || this.$route.meta.title
      this.partakeResearchDto.customerId = this.$route.params.id
      if (this.$route.params.data) {
        this.partakeResearchDto.beginDate = this.$route.params.data.beginDate.slice(0, 10)
        this.partakeResearchDto.researchName = this.$route.params.data.researchName
        this.partakeResearchDto.researchType = this.$route.params.data.researchType
        this.partakeResearchDto.researchTypeOther = this.$route.params.data.researchTypeOther
        this.partakeResearchDto.partakeMode = this.$route.params.data.partakeMode
        this.partakeResearchDto.partakeModeOther = this.$route.params.data.partakeModeOther
        this.partakeResearchDto['id'] = this.$route.params.data.id

      }

    },
    methods: {
      goEssentialInfo () {
        for(let key in this.partakeResearchDto) {
          switch (key) {
            case 'beginDate':
              if(this.partakeResearchDto[key] === '' || null) {this.$vux.toast.text('开始年度不能为空', 'middle'); return;}
              break
            case 'researchName':
              if(this.partakeResearchDto[key] === '' || null) {this.$vux.toast.text('课题名称不能为空', 'middle'); return;}
              break
            case 'researchType':
              if(this.partakeResearchDto[key] === '' || null) {this.$vux.toast.text('课题类型不能为空', 'middle'); return;}
              break
            case 'researchTypeOther':
              if (this.partakeResearchDto.researchType == 'KTLX04'){
                if (this.partakeResearchDto[key] === '' || null) {
                  this.$vux.toast.text('课程类型其他不能为空', 'middle');
                  return;
                }}
                break
            case 'partakeMode':
              if(this.partakeResearchDto[key] === '' || null) {this.$vux.toast.text('参与方式不能为空', 'middle'); return;}
              break
            case 'partakeModeOther':
              if (this.partakeResearchDto.partakeMode == 'CYFS04'){
                if (this.partakeResearchDto[key] === '' || null) {
                  this.$vux.toast.text('参与方式其他不能为空', 'middle');
                  return;
                }}
              break
          }

        }
        if (this.title === '编辑参与课题') {
          this.$put('/api/partakeResearch', this.partakeResearchDto).then(info => {
            this.$vux.toast.text('编辑参与课题成功', 'middle')
            this.$router.push({
              path:`/userInfo/${this.partakeResearchDto.customerId}/follow-details/${this.partakeResearchDto.customerId}`,
              query:{
                previousPage: this.backField.previousPage || this.$route.query.previousPage,
                subId:this.$route.params.personId || this.backField.subId,
                isOpen:'showContent4'
              }
            })
            sessionStorage.setItem('tabIndex', '3');
          }).catch(error => {
            this.$vux.toast.text('编辑参与课题失败', 'middle')
          })
        } else if (this.title === '新建参与课题') {
          this.$post('/api/partakeResearch', this.partakeResearchDto).then(info => {
            this.$vux.toast.text('新建参与课题成功', 'middle')
            this.$router.push({
              path:`/userInfo/${this.partakeResearchDto.customerId}/follow-details/${this.partakeResearchDto.customerId}`,
              query:{
                previousPage: this.backField.previousPage || this.$route.query.previousPage,
                subId:this.$route.query.personId,
                isOpen:'showContent4'
              }
            })
            sessionStorage.setItem('tabIndex', '3');
          }).catch(error => {
            this.$vux.toast.text('新建参与课题失败', 'middle')
          })
        }
      },
      goToBack(){
        if (this.backField.previousPage == 'concernSub' && this.backField.subId == 'undefined') {
          this.$router.push({
            path:'/subordinates-customer/' +this.$route.query.personId,
            query:{
              previousPage:this.backField.previousPage
            },
          })
          return
        }

        if (this.start == '0') {
          this.$router.push({
            path: '/see-all',
            query:{
              title:'全部参与课题信息',
              isEdit: 1,
              id:this.customerId,
              isOpen: 'showContent4',
              backField:this.backField
            }
          })
          return
        }
        if (this.start == '1') {
          this.$router.push({
            path: '/userInfo/' + this.customerId + '/follow-details/' + this.customerId,
            query: {
              previousPage: this.backField.previousPage,
              subId: this.backField.subId,
              isOpen: 'showContent4'
            }
          })
          sessionStorage.setItem('tabIndex', '3')
          return
        }
        this.$router.push('/customer')

      }
    },
    beforeRouteLeave (to, from, next) {
      if (!to.params.id) {
        to.params.title = '全部参与课题信息'
        to.params.id = this.partakeResearchDto.customerId
      }
      next()
    },

  }
</script>
<style lang="less">
  .newTop {
    .dy-top {
      .x-header {
        h1.vux-header-title {
          font-size: 19px;
        }
        .vux-header-right {
          font-size: 15px;
        }
      }
    }
    .cellBox {
      height: 20px;
    }
    .backgroundStyle {
      font-size: 13px;
    }
  }
</style>

