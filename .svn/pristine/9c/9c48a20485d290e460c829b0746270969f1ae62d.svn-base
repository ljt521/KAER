<!--作者：莫岭红 功能：新建（编辑）学术参与-->
<template>
  <div v-wechat-title="title" class="newLearn">
    <div class="dy-top">
      <x-header class="x-header" slot="header" @on-click-back="goToBack" :left-options="{backText: '',preventGoBack: true}">{{title}}<a slot="right"
                                                                                          @click="goEssentialInfo()">完成</a>
      </x-header>
    </div>
    <div class="backgroundStyle">
      <datetime v-model="academicJoinDto.academicDate" title="日期" placeholder="请选择" :is-type="codeValue"></datetime>
      <div-selector :tilteValue="'活动类型'" :dictCode="'CH'"
          v-on:listenSelect="(value) => {academicJoinDto.academicActivityType = value.code}"
          :anyData="academicJoinDto.academicActivityType" :is-type="codeValue" required></div-selector>
      <div v-if="academicJoinDto.academicActivityType === 'CH04'">
        <x-input type="text" placeholder="请填写" v-model="academicJoinDto.academicActivityTypeOther" :is-type="codeValue" text-align="right" required></x-input>
      </div>
      <x-input title="活动名称" v-model="academicJoinDto.activityName" placeholder="请填写" text-align="right" :is-type="codeValue" required></x-input>
      <div-selector :tilteValue="'参与角色'" :dictCode="'SSJS'"
                    v-on:listenSelect="(value) => {academicJoinDto.participantRoles = value.code}"
                    :anyData="academicJoinDto.participantRoles" :is-type="codeValue" required></div-selector>
      <div v-if="academicJoinDto.participantRoles === 'SSJS05'">
        <x-input type="text" placeholder="请填写" v-model="academicJoinDto.participantRolesOther" :is-type="codeValue" text-align="right" required></x-input>
      </div>
    </div>
  </div>
</template>
<script>
  export default {
    name: 'NewLearning',
    data () {
      return {
        codeValue: function (value) {
          return {
            valid: value !== '' || null,
          }
        },
        title: '新建学术参与',
        backField: {},
        isEdit: '',
        start:'', //状态 1为创建 0为编辑
        customerId: '',
        academicJoinDto: {
          customerId: '',//所属客户
          academicDate: '',//日期
          academicActivityType: '',//学术活动类型
          academicActivityTypeOther: '',//学术活动类型其他
          activityName: '',//活动名称
          participantRoles: '',//参与角色
          participantRolesOther: ''//参与角色其他
        }
      }
    },
    mounted() {
      this.customerId = this.$route.params.id || this.$route.query.id
      if (this.$route.params.isEdit) {
        this.isEdit = this.$route.params.isEdit
        this.backField = this.$route.params.backField
        this.personId = this.$route.params.personId
        this.start = this.$route.params.start
      }

      if (this.$route.query.previousPage) {
        this.backField = {previousPage:'',subId:''}
        this.backField.previousPage = this.$route.query.previousPage
        this.backField.subId = this.$route.query.subId
        this.start = 1;
      }
    },
    created () {
      this.title = this.$route.params.title || this.$route.meta.title
      this.academicJoinDto.customerId = this.$route.params.id
      if (this.$route.params.data) {
        this.academicJoinDto.academicDate = this.$route.params.data.academicDate
        this.academicJoinDto.activityName = this.$route.params.data.activityName
        this.academicJoinDto.academicActivityType = this.$route.params.data.academicActivityType
        this.academicJoinDto.academicActivityTypeOther = this.$route.params.data.academicActivityTypeOther
        this.academicJoinDto.participantRoles = this.$route.params.data.participantRoles
        this.academicJoinDto.participantRolesOther = this.$route.params.data.participantRolesOther
        this.academicJoinDto['id'] = this.$route.params.data.id
      }
    },
    methods: {
      goEssentialInfo () {
        for(let key in this.academicJoinDto) {
          switch (key) {
            case 'academicDate':
              if(this.academicJoinDto[key] === '' || null) {this.$vux.toast.text('日期不能为空', 'middle'); return;}
              break
            case 'academicActivityType':
              if(this.academicJoinDto[key] === '' || null) {this.$vux.toast.text('学术活动类型不能为空', 'middle'); return;}
              break
            case 'academicActivityTypeOther':
              if (this.academicJoinDto.academicActivityType === 'CH04') {
                if(this.academicJoinDto[key] === '' || null) {this.$vux.toast.text('学术活动其他类型不能为空', 'middle'); return;}
              }
              break
            case 'activityName':
              if(this.academicJoinDto[key] === '' || null) {this.$vux.toast.text('活动名称不能为空', 'middle'); return;}
              break
            case 'participantRoles':
              if(this.academicJoinDto[key] === '' || null) {this.$vux.toast.text('参与角色不能为空', 'middle'); return;}
              break
            case 'participantRolesOther':
              if (this.academicJoinDto.participantRoles === 'SSJS05') {
                if(this.academicJoinDto[key] === '' || null) {this.$vux.toast.text('参与其他角色不能为空', 'middle'); return;}
              }
              break
          }
        }
        if (this.title === '编辑学术参与') {
          this.$put('/api/AcademicJoin', this.academicJoinDto).then(info => {
            this.$vux.toast.text('编辑学术参与成功', 'middle')
            this.$router.push({
              path:`/userInfo/${this.academicJoinDto.customerId}/follow-details/${this.academicJoinDto.customerId}`,
              query:{
                previousPage: this.backField.previousPage || this.$route.query.previousPage,
                subId:this.$route.params.personId || this.backField.subId,
                isOpen:'showContent6'
              }
            })
            sessionStorage.setItem('tabIndex', '3');
          }).catch(error => {
            this.$vux.toast.text('编辑学术参与失败', 'middle')
          })
        } else if (this.title === '新建学术参与') {
          this.$post('/api/AcademicJoin', this.academicJoinDto).then(info => {
            this.$vux.toast.text('新建学术参与成功', 'middle')
            this.$router.push({
              path:`/userInfo/${this.academicJoinDto.customerId}/follow-details/${this.academicJoinDto.customerId}`,
              query:{
                previousPage: this.backField.previousPage || this.$route.query.previousPage,
                subId:this.$route.query.personId,
                isOpen:'showContent6'
              }
            })
            sessionStorage.setItem('tabIndex', '3');
          }).catch(error => {
            this.$vux.toast.text('新建学术参与失败', 'middle')
          })
        }
      },
      goToBack(){
        if (this.backField.previousPage == 'concernSub' && this.backField.subId == 'undefined') {
          this.$router.push({
            path:'/subordinates-customer/' +this.$route.query.personId,
            query:{
              previousPage:this.backField.previousPage
            },
          })
          return
        }

        if (this.start == '0') {
          this.$router.push({
            path: '/see-all',
            query:{
              title:'全部学术参与信息',
              isEdit: 1,
              id:this.customerId,
              isOpen: 'showContent6',
              backField:this.backField
            }
          })
          return
        }
        if (this.start == '1') {
          this.$router.push({
            path: '/userInfo/' + this.customerId  + '/follow-details/' + this.customerId,
            query: {
              previousPage: this.backField.previousPage,
              subId: this.backField.subId,
              isOpen: 'showContent6',
            }
          })
          sessionStorage.setItem('tabIndex', '3')
          return
        }
        this.$router.push('/customer')

      }
    },
    beforeRouteLeave (to, from, next) {
      if (!to.params.id) {
        to.params.title = '全部学术参与信息'
        to.params.id = this.academicJoinDto.customerId
        to.params.isOpen = this.isOpen;//
        to.params.backField = this.backField;//上一个页面内容
        to.params.isEdit = this.isEdit;//是否可编辑

      }
      next()
    },
  }
</script>


<style lang="less">
  .newLearn {
    .dy-top {
      .x-header {
        h1.vux-header-title {
          font-size: 19px;
        }
        .vux-header-right {
          font-size: 15px;
        }
      }
    }
    .cellBox {
      height: 20px;
    }
    .backgroundStyle {
      font-size: 13px;
    }
  }


</style>
